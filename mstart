#!/usr/bin/env bash
# Start all Mobius backends, frontends, and workers using shared venv.
# Usage: mstart [--no-rag-frontend] [--no-os-extension] [--no-landing]

set -e
SCRIPT="$0"
while [ -L "$SCRIPT" ]; do
  TARGET="$(readlink "$SCRIPT")"
  [[ "$TARGET" == /* ]] && SCRIPT="$TARGET" || SCRIPT="$(dirname "$SCRIPT")/$TARGET"
done
MOBIUS_ROOT="$(cd "$(dirname "$SCRIPT")" && pwd)"
cd "$MOBIUS_ROOT" || exit 1

PIDFILE="$MOBIUS_ROOT/.mobius_start_all.pids"
LOGDIR="$MOBIUS_ROOT/.mobius_logs"
VENV="$MOBIUS_ROOT/.venv"
mkdir -p "$LOGDIR"

# Check for shared venv
if [[ ! -d "$VENV" ]]; then
  echo "[mstart] ERROR: Shared venv not found at $VENV"
  echo "  Create it: cd $MOBIUS_ROOT && python3.11 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt"
  exit 1
fi

START_RAG_FRONTEND=true
START_OS_EXTENSION=true
START_LANDING=true
RESTART_CLOUDSQL=false
for arg in "$@"; do
  case "$arg" in
    --no-rag-frontend) START_RAG_FRONTEND=false ;;
    --no-os-extension) START_OS_EXTENSION=false ;;
    --no-landing) START_LANDING=false ;;
    --restart-db) RESTART_CLOUDSQL=true ;;
  esac
done

# When --no-landing, preserve mobius-landing PIDs (don't kill, keep in file at end)
LANDING_LINES=""
if [[ "$START_LANDING" == "false" ]] && [[ -f "$PIDFILE" ]]; then
  while read -r pid name; do
    [[ -z "$pid" ]] || [[ ! "$name" ]] && continue
    if [[ "$name" == "mobius-landing" ]]; then
      LANDING_LINES="${LANDING_LINES}${pid} ${name}"$'\n'
    fi
  done < "$PIDFILE"
fi

# --- Kill existing servers first ---
if [[ -f "$PIDFILE" ]]; then
  echo "[mstart] Stopping existing Mobius processes ..."
  while read -r pid name; do
    [[ -z "$pid" ]] && continue
    if [[ "$START_LANDING" == "false" ]] && [[ "$name" == "mobius-landing" ]]; then
      continue
    fi
    if kill -0 "$pid" 2>/dev/null; then
      kill "$pid" 2>/dev/null || true
      echo "  Stopped $name (PID $pid)"
    fi
  done < "$PIDFILE"
  if [[ "$START_LANDING" == "true" ]]; then
    rm -f "$PIDFILE"
  fi
  echo "[mstart] Waiting for processes to exit ..."
  sleep 2
fi

: > "$PIDFILE"

_log() { echo "[mstart] $*"; }

# Kill any process bound to port so services can bind to fixed ports.
_kill_port() {
  local port=$1
  local pids
  pids=$(lsof -ti :"$port" 2>/dev/null) || true
  if [[ -n "$pids" ]]; then
    _log "Freeing port $port (killing existing process)"
    echo "$pids" | xargs kill -9 2>/dev/null || true
    sleep 2
  fi
}

_start() {
  local name="$1"
  local cmd="$2"
  _log "Starting $name ..."
  eval "$cmd" >> "$LOGDIR/${name}.log" 2>&1 &
  local pid=$!
  echo "$pid $name" >> "$PIDFILE"
  _log "  PID $pid"
}

# Ensure Cloud SQL Auth Proxy (or local Postgres) is available on 127.0.0.1:5432.
_ensure_cloud_sql_proxy() {
  # If something already listens on 5432 (local postgres or proxy), we're good.
  if lsof -nP -iTCP:5432 -sTCP:LISTEN >/dev/null 2>&1; then
    return
  fi

  # Best-effort default for dev if not set.
  if [[ -z "${CLOUDSQL_CONNECTION_NAME:-}" ]]; then
    CLOUDSQL_CONNECTION_NAME="mobius-os-dev:us-central1:mobius-platform-dev-db"
    export CLOUDSQL_CONNECTION_NAME
  fi

  # If cloud-sql-proxy is available, start it.
  if command -v cloud-sql-proxy >/dev/null 2>&1; then
    _log "Starting Cloud SQL Auth Proxy on 127.0.0.1:5432 ..."
    _start "mobius-cloud-sql-proxy" "cloud-sql-proxy \"${CLOUDSQL_CONNECTION_NAME}\" --address=127.0.0.1 --port=5432"
    # Give it a moment to bind.
    sleep 1
  else
    _log "WARNING: Nothing is listening on 127.0.0.1:5432 and cloud-sql-proxy is not installed."
    _log "  Install: brew install cloud-sql-proxy"
  fi
}

# Wait for Redis at REDIS_URL (used after starting tunnel). Up to 15s.
_wait_redis() {
  sleep 2
  if [[ ! -x "$VENV/bin/python3" ]]; then return; fi
  local i
  for (( i=0; i<15; i++ )); do
    if ( cd "$MOBIUS_ROOT/mobius-skills/web-scraper" 2>/dev/null && "$VENV/bin/python3" -c "
import sys; sys.path.insert(0, '.'); from app.config import REDIS_URL
import redis; redis.from_url(REDIS_URL, socket_connect_timeout=2).ping()
" 2>/dev/null ); then
      _log "  Redis reachable"
      return
    fi
    sleep 1
  done
  _log "  Redis not reachable yet (tunnel may still be connecting)"
}

# Load .env files for services that need env vars
_load_env() {
  local envfile="$1"
  if [[ -f "$envfile" ]]; then
    while IFS= read -r _mline || [[ -n "$_mline" ]]; do
      [[ -z "$_mline" || "$_mline" =~ ^[[:space:]]*# ]] && continue
      if [[ "$_mline" =~ ^([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
        # Export literally (avoid shell expansion of $... sequences in values).
        local k="${BASH_REMATCH[1]}"
        local v="${BASH_REMATCH[2]}"
        printf -v "$k" '%s' "$v"
        export "$k"
      fi
    done < "$envfile"
  fi
}

# Derive Postgres user/pass from a URL (best-effort; works for simple passwords).
_pg_user_from_url() {
  local url="$1"
  if [[ "$url" =~ ^postgresql(\+asyncpg)?://([^:/]+):([^@]+)@ ]]; then
    printf "%s" "${BASH_REMATCH[2]}"
  fi
}
_pg_pass_from_url() {
  local url="$1"
  if [[ "$url" =~ ^postgresql(\+asyncpg)?://([^:/]+):([^@]+)@ ]]; then
    printf "%s" "${BASH_REMATCH[3]}"
  fi
}
_to_psycopg_url() {
  local url="$1"
  # Convert postgresql+asyncpg:// → postgresql:// for psycopg2
  printf "%s" "${url/postgresql+asyncpg:\/\//postgresql:\/\/}"
}

# --- Restart Cloud SQL to clear connections (optional, for "connection slots" errors) ---
if [[ "$RESTART_CLOUDSQL" == "true" ]]; then
  _log "Restarting Cloud SQL instance (clears all connections) ..."
  CLOUDSQL_INST="${CLOUDSQL_INSTANCE:-mobius-platform-dev-db}"
  CLOUDSQL_PROJ="${GCP_PROJECT:-mobius-os-dev}"
  if command -v gcloud >/dev/null 2>&1; then
    gcloud sql instances restart "$CLOUDSQL_INST" --project="$CLOUDSQL_PROJ" --quiet 2>/dev/null && _log "  Instance restarted. Waiting 35s ..." && sleep 35 || _log "  Restart failed or skipped"
  else
    _log "  gcloud not found; skip --restart-db"
  fi
fi

# --- mobius-chat DB migrations (run before starting chat services) ---
if [[ -d "$MOBIUS_ROOT/mobius-chat" ]]; then
  _log "Running mobius-chat DB migrations ..."
  # After killing processes, wait for DB connections to close, then try cleanup
  sleep 3
  if [[ -x "$VENV/bin/python3" ]] && [[ -f "$MOBIUS_ROOT/scripts/cleanup_db_connections.py" ]]; then
    _log "Cleaning up idle DB connections ..."
    "$VENV/bin/python3" "$MOBIUS_ROOT/scripts/cleanup_db_connections.py" 2>/dev/null || true
  fi
  _load_env "$MOBIUS_ROOT/mobius-chat/.env"
  if (cd "$MOBIUS_ROOT/mobius-chat" && "$VENV/bin/python3" -m app.db.run_migrations 2>&1); then
    _log "Migrations OK"
  else
    _log "Migrations failed or skipped (check CHAT_RAG_DATABASE_URL in mobius-chat/.env)"
    _log "  If you see 'connection slots' error, run: ./mstart --restart-db"
  fi
fi

# --- mobius-os backend (port 5001) ---
if [[ -d "$MOBIUS_ROOT/mobius-os/backend" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-os/backend/.env"
  _start "mobius-os-backend" "cd $MOBIUS_ROOT/mobius-os/backend && $VENV/bin/python server.py"
fi

# --- mobius-os extension (webpack watch) ---
if [[ "$START_OS_EXTENSION" == "true" ]] && [[ -d "$MOBIUS_ROOT/mobius-os/extension" ]]; then
  if command -v npm >/dev/null 2>&1; then
    _start "mobius-os-extension" "cd $MOBIUS_ROOT/mobius-os/extension && npm run dev"
  else
    _log "Skip mobius-os extension (npm not found)"
  fi
fi

# --- Redis: start tunnel if REDIS_URL is localhost:6380 (IAP/SSH tunnel to cloud Redis) ---
_load_env "$MOBIUS_ROOT/mobius-skills/web-scraper/.env"
if [[ -f "$MOBIUS_ROOT/mobius-config/.env" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-config/.env"
fi

# If DB access is via Cloud SQL proxy locally, ensure it's running early.
_ensure_cloud_sql_proxy

REDIS_URL="${REDIS_URL:-}"
if [[ "$REDIS_URL" == *"127.0.0.1:6380"* ]] || [[ "$REDIS_URL" == *"localhost:6380"* ]]; then
  _log "Redis tunnel target (127.0.0.1:6380) detected; starting tunnel if configured ..."
  _kill_port 6380
  if [[ -n "${REDIS_TUNNEL_CMD:-}" ]]; then
    _start "mobius-redis-tunnel" "$REDIS_TUNNEL_CMD"
    _wait_redis
  elif [[ -n "${REDIS_TUNNEL_JUMP_INSTANCE:-}" ]]; then
    REDIS_TUNNEL_JUMP_ZONE="${REDIS_TUNNEL_JUMP_ZONE:-us-central1-a}"
    _start "mobius-redis-tunnel" "gcloud compute ssh $REDIS_TUNNEL_JUMP_INSTANCE --zone=$REDIS_TUNNEL_JUMP_ZONE -- -L 6380:10.40.102.67:6379 -N -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
    _wait_redis
  else
    _log "  Set REDIS_TUNNEL_CMD or REDIS_TUNNEL_JUMP_INSTANCE (and optional REDIS_TUNNEL_JUMP_ZONE) in mobius-config/.env or web-scraper/.env to start the tunnel automatically."
    _log "  Or use local Redis: REDIS_URL=redis://localhost:6379/0 and run: brew services start redis"
  fi
fi
_log "Note: Redis at ${REDIS_URL:-redis://10.40.102.67:6379/0}"

# --- mobius-chat API (port 8000) ---
if [[ -d "$MOBIUS_ROOT/mobius-chat" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-chat/.env"
  _start "mobius-chat-api" "cd $MOBIUS_ROOT/mobius-chat && $VENV/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000"
fi

# --- mobius-chat worker ---
if [[ -d "$MOBIUS_ROOT/mobius-chat" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-chat/.env"
  _start "mobius-chat-worker" "cd $MOBIUS_ROOT/mobius-chat && $VENV/bin/python3 -m app.worker"
fi

# --- mobius-rag backend (port 8001) ---
if [[ -d "$MOBIUS_ROOT/mobius-rag" ]]; then
  _kill_port 8001
  _load_env "$MOBIUS_ROOT/mobius-rag/.env"
  _start "mobius-rag-backend" "cd $MOBIUS_ROOT/mobius-rag && $VENV/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload"
fi

# --- mobius-rag chunking worker ---
if [[ -d "$MOBIUS_ROOT/mobius-rag" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-rag/.env"
  _start "mobius-rag-chunking-worker" "cd $MOBIUS_ROOT/mobius-rag && $VENV/bin/python3 -m app.worker"
fi

# --- mobius-rag embedding worker ---
if [[ -f "$MOBIUS_ROOT/mobius-rag/app/embedding_worker.py" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-rag/.env"
  _start "mobius-rag-embedding-worker" "cd $MOBIUS_ROOT/mobius-rag && $VENV/bin/python3 -m app.embedding_worker"
fi

# --- mobius-qa lexicon maintenance API (port 8010) ---
# Serves the Lexicon UI data endpoints used by the static app under /lexicon/.
if [[ -d "$MOBIUS_ROOT/mobius-qa/lexicon-maintenance" ]]; then
  _kill_port 8010
  # Prefer explicit URLs if provided; else derive from RAG/chat creds and assume local Cloud SQL proxy on 127.0.0.1:5432.
  _load_env "$MOBIUS_ROOT/mobius-qa/lexicon-maintenance/.env"
  _load_env "$MOBIUS_ROOT/mobius-rag/.env"
  _load_env "$MOBIUS_ROOT/mobius-chat/.env"

  if [[ -z "${QA_DATABASE_URL:-}" ]]; then
    # Derive credentials from DATABASE_URL or CHAT_RAG_DATABASE_URL, then point to mobius_qa on localhost.
    local_src="${DATABASE_URL:-${CHAT_RAG_DATABASE_URL:-}}"
    local_user="$(_pg_user_from_url "$local_src")"
    local_pass="$(_pg_pass_from_url "$local_src")"
    if [[ -n "$local_user" && -n "$local_pass" ]]; then
      QA_DATABASE_URL="postgresql://${local_user}:${local_pass}@127.0.0.1:5432/mobius_qa?connect_timeout=5"
    fi
  fi
  if [[ -z "${RAG_DATABASE_URL:-}" ]]; then
    # Derive credentials from DATABASE_URL and force local DB name/host.
    local_src="${DATABASE_URL:-${CHAT_RAG_DATABASE_URL:-}}"
    local_user="$(_pg_user_from_url "$local_src")"
    local_pass="$(_pg_pass_from_url "$local_src")"
    if [[ -n "$local_user" && -n "$local_pass" ]]; then
      RAG_DATABASE_URL="postgresql://${local_user}:${local_pass}@127.0.0.1:5432/mobius_rag?connect_timeout=5"
    fi
  fi

  export QA_DATABASE_URL RAG_DATABASE_URL
  _start "mobius-qa-lexicon-api" "cd $MOBIUS_ROOT/mobius-qa/lexicon-maintenance && $VENV/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8010"
fi

# --- mobius-qa retrieval eval studio API (port 8020) ---
# Persists retrieval test suites + runs in mobius_qa; runs BM25 vs Vertex hierarchical eval.
if [[ -d "$MOBIUS_ROOT/mobius-qa/retrieval-eval-studio" ]]; then
  _kill_port 8020
  _load_env "$MOBIUS_ROOT/mobius-qa/retrieval-eval-studio/.env"
  _load_env "$MOBIUS_ROOT/mobius-chat/.env"
  _load_env "$MOBIUS_ROOT/mobius-rag/.env"

  # Ensure QA_DATABASE_URL points to local Cloud SQL proxy (same pattern as lexicon API).
  if [[ -z "${QA_DATABASE_URL:-}" ]]; then
    local_src="${DATABASE_URL:-${CHAT_RAG_DATABASE_URL:-}}"
    local_user="$(_pg_user_from_url "$local_src")"
    local_pass="$(_pg_pass_from_url "$local_src")"
    if [[ -n "$local_user" && -n "$local_pass" ]]; then
      QA_DATABASE_URL="postgresql://${local_user}:${local_pass}@127.0.0.1:5432/mobius_qa?connect_timeout=5"
      export QA_DATABASE_URL
    fi
  fi

  # Normalize Vertex env var names (Chat uses *PROJECT_ID/*LOCATION and CHAT_* aliases).
  if [[ -z "${VERTEX_PROJECT:-}" ]]; then
    VERTEX_PROJECT="${VERTEX_PROJECT_ID:-${CHAT_VERTEX_PROJECT_ID:-}}"
    export VERTEX_PROJECT
  fi
  if [[ -z "${VERTEX_REGION:-}" ]]; then
    VERTEX_REGION="${VERTEX_LOCATION:-${CHAT_VERTEX_LOCATION:-us-central1}}"
    export VERTEX_REGION
  fi
  if [[ -z "${VERTEX_INDEX_ENDPOINT_ID:-}" ]]; then
    VERTEX_INDEX_ENDPOINT_ID="${CHAT_VERTEX_INDEX_ENDPOINT_ID:-}"
    export VERTEX_INDEX_ENDPOINT_ID
  fi
  if [[ -z "${VERTEX_DEPLOYED_INDEX_ID:-}" ]]; then
    VERTEX_DEPLOYED_INDEX_ID="${CHAT_VERTEX_DEPLOYED_INDEX_ID:-}"
    export VERTEX_DEPLOYED_INDEX_ID
  fi
  # If endpoint id is a full resource name, prefer its project over placeholder defaults.
  if [[ -n "${VERTEX_INDEX_ENDPOINT_ID:-}" ]] && [[ "${VERTEX_INDEX_ENDPOINT_ID}" =~ projects/([^/]+)/ ]]; then
    VERTEX_PROJECT="${BASH_REMATCH[1]}"
    export VERTEX_PROJECT
  fi

  export QA_DATABASE_URL CHAT_RAG_DATABASE_URL VERTEX_PROJECT VERTEX_REGION VERTEX_INDEX_ENDPOINT_ID VERTEX_DEPLOYED_INDEX_ID
  _start "mobius-qa-retrieval-eval-studio" "cd $MOBIUS_ROOT/mobius-qa/retrieval-eval-studio && $VENV/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8020"
fi

# --- mobius-skills scraper API (port 8002) ---
if [[ -d "$MOBIUS_ROOT/mobius-skills/web-scraper" ]]; then
  _kill_port 8002
  _load_env "$MOBIUS_ROOT/mobius-skills/web-scraper/.env"
  _start "mobius-scraper-api" "cd $MOBIUS_ROOT/mobius-skills/web-scraper && $VENV/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8002"
fi

# --- mobius-skills scraper worker ---
if [[ -d "$MOBIUS_ROOT/mobius-skills/web-scraper" ]]; then
  _load_env "$MOBIUS_ROOT/mobius-skills/web-scraper/.env"
  _start "mobius-scraper-worker" "cd $MOBIUS_ROOT/mobius-skills/web-scraper && $VENV/bin/python3 -m app.worker"
fi

# --- mobius-rag frontend (port 5173) ---
if [[ "$START_RAG_FRONTEND" == "true" ]] && [[ -d "$MOBIUS_ROOT/mobius-rag/frontend" ]]; then
  if command -v npm >/dev/null 2>&1; then
    _kill_port 5173
    # Use /api-rag proxy (no VITE_API_BASE) so requests are same-origin, avoiding CORS
_start "mobius-rag-frontend" "cd $MOBIUS_ROOT/mobius-rag/frontend && VITE_SCRAPER_API_BASE=http://localhost:8002 npm run dev"
  else
    _log "Skip mobius-rag frontend (npm not found)"
  fi
fi

# --- Master landing (port 3999) ---
if [[ "$START_LANDING" == "true" ]] && [[ -f "$MOBIUS_ROOT/landing_server.py" ]]; then
  _kill_port 3999
  _start "mobius-landing" "cd $MOBIUS_ROOT && $VENV/bin/python3 landing_server.py"
fi

# Restore mobius-landing lines to PID file when we did --no-landing
if [[ "$START_LANDING" == "false" ]] && [[ -n "$LANDING_LINES" ]]; then
  printf "%s" "$LANDING_LINES" >> "$PIDFILE"
fi

sleep 1
echo ""
echo "=============================================="
echo "  Mobius status — services started"
echo "=============================================="
echo ""
printf "  %-24s  %s\n" "Service" "URL"
printf "  %-24s  %s\n" "-------" "---"
printf "  %-24s  %s\n" "mobius-os backend"    "http://localhost:5001"
printf "  %-24s  %s\n" "mobius-chat"         "http://localhost:8000"
printf "  %-24s  %s\n" "mobius-rag backend"  "http://localhost:8001"
printf "  %-24s  %s\n" "mobius-scraper API"  "http://localhost:8002"
printf "  %-24s  %s\n" "mobius-rag frontend" "http://localhost:5173"
printf "  %-24s  %s\n" "mobius-qa lexicon API" "http://localhost:8010"
printf "  %-24s  %s\n" "mobius-qa retrieval eval" "http://localhost:8020"
if [[ "$START_LANDING" == "true" ]]; then
  printf "  %-24s  %s\n" "Master landing"     "http://localhost:3999"
fi
echo ""
echo "  Shared venv: $VENV"
echo "  PIDs: $PIDFILE"
echo "  Logs: $LOGDIR"
echo "  Stop: ./mstop  (or mstop if Mobius is on PATH)"
echo ""
echo "  Cloud resources (dev):"
echo "    PostgreSQL: 34.135.72.145:5432"
echo "    Redis: 10.40.102.67:6379 (requires VPN/tunnel)"
echo ""
